<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"01lv.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="主要参考：SpringBoot之多数据源动态切换数据源 其它参考： Spring Boot 动态数据源(多数据源自动切换) spring boot使用AbstractRoutingDataSource实现动态数据源切换 AbstractRoutingDataSource – Spring提供的轻量级数据源切换方式 【Spring】使用Spring的AbstractRoutingDataSource">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot多数据源切换学习总结">
<meta property="og:url" content="https://01lv.github.io/2020/03/05/SpringBoot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="追风的少年">
<meta property="og:description" content="主要参考：SpringBoot之多数据源动态切换数据源 其它参考： Spring Boot 动态数据源(多数据源自动切换) spring boot使用AbstractRoutingDataSource实现动态数据源切换 AbstractRoutingDataSource – Spring提供的轻量级数据源切换方式 【Spring】使用Spring的AbstractRoutingDataSource">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/131.png">
<meta property="og:image" content="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/132.png">
<meta property="og:image" content="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/133.png">
<meta property="og:image" content="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/129.png">
<meta property="og:image" content="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC80LzMvMTYyODk2YWIxYTFkMWUyZQ?x-oss-process=image/format,png">
<meta property="og:image" content="https://img-blog.csdn.net/20160811192425854">
<meta property="og:image" content="https://img-blog.csdn.net/20160811192446479">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200306232559114.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200307165337725.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pa2VsdjAx,size_16,color_FFFFFF,t_70">
<meta property="article:published_time" content="2020-03-05T15:37:15.000Z">
<meta property="article:modified_time" content="2020-04-02T11:39:01.337Z">
<meta property="article:author" content="mikelv">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="多数据源">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/131.png">

<link rel="canonical" href="https://01lv.github.io/2020/03/05/SpringBoot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>SpringBoot多数据源切换学习总结 | 追风的少年</title>
  







  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">追风的少年</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">just have a little faith</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://01lv.github.io/2020/03/05/SpringBoot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="mikelv">
      <meta itemprop="description" content="放弃不难，但坚持一定很酷">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风的少年">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringBoot多数据源切换学习总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-05 23:37:15" itemprop="dateCreated datePublished" datetime="2020-03-05T23:37:15+08:00">2020-03-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-02 19:39:01" itemprop="dateModified" datetime="2020-04-02T19:39:01+08:00">2020-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/03/05/SpringBoot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/03/05/SpringBoot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>20 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>主要参考：<a href="https://www.cnblogs.com/shihaiming/p/11067623.html" target="_blank" rel="noopener">SpringBoot之多数据源动态切换数据源</a></p>
<p>其它参考：</p>
<p><a href="https://blog.csdn.net/catoop/article/details/50575038" target="_blank" rel="noopener">Spring Boot 动态数据源(多数据源自动切换)</a></p>
<p><a href="https://blog.csdn.net/qq_37502106/article/details/91044952" target="_blank" rel="noopener">spring boot使用AbstractRoutingDataSource实现动态数据源切换</a></p>
<p><a href="https://www.jianshu.com/p/b158476dd33c" target="_blank" rel="noopener">AbstractRoutingDataSource – Spring提供的轻量级数据源切换方式</a></p>
<p><a href="https://www.jianshu.com/p/a042ff2ee2ae" target="_blank" rel="noopener">【Spring】使用Spring的AbstractRoutingDataSource实现多数据源切换</a></p>
<p><a href="https://www.jianshu.com/p/3c5d7f09dfbd" target="_blank" rel="noopener">ThreadLocal</a></p>
<p><a href="https://juejin.im/post/5ac2eb52518825555e5e06ee" target="_blank" rel="noopener">ThreadLocal就是这么简单</a></p>
<p><a href="https://blog.csdn.net/rainbow702/article/details/52185827" target="_blank" rel="noopener">Spring AOP @Before @Around @After 等 advice 的执行顺序</a></p>
<p><a href="https://blog.csdn.net/u010502101/article/details/78823056" target="_blank" rel="noopener">AspectJ 切面注解中五种通知注解：@Before、@After、@AfterRunning、@AfterThrowing、@Around</a></p>
<p><a href="https://www.xiefayang.com/2019/04/01/Spring%20Boot%20%E9%85%8D%E7%BD%AE%E7%BB%91%E5%AE%9A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" target="_blank" rel="noopener">Spring Boot 2.0源码解析-配置绑定</a></p>
<p><a href="http://blog.didispace.com/Spring-Boot-2-0-feature-1-relaxed-binding-2/" target="_blank" rel="noopener">Spring Boot 2.0 新特性（一）：配置绑定 2.0 全解析</a></p>
<p><a href="https://www.cnblogs.com/aheizi/p/7071181.html" target="_blank" rel="noopener">Java注解–实现动态数据源切换</a></p>
<p><a href="https://webfuse.cn/2017/08/10/%E5%88%A9%E7%94%A8Spring%E7%9A%84AbstractRoutingDataSource%E8%A7%A3%E5%86%B3%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">利用Spring的AbstractRoutingDataSource解决多数据源的问题</a></p>
<a id="more"></a>

<blockquote>
<h3><span id="数据源定义">数据源定义</span></h3></blockquote>
<p>Java中的数据源就是连接到数据库的一条路径，数据源中并无真正的数据，它仅仅记录的是你连接到哪个数据库，以及如何连接。DataSource的创建可以有不同的实现。DataSource通常被称为数据源，它包含连接池 和连接池管理 两部分，习惯上也经常把DataSource称为连接池</p>
<blockquote>
<h3><span id="springboot-读取配置文件方式">SpringBoot 读取配置文件方式</span></h3></blockquote>
<p>SpringBoot2.x 开始推荐读取配置文件的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Binder binder = Binder.get(environment);<span class="comment">//简单绑定</span></span><br><span class="line"><span class="keyword">this</span>.defaultDataSourceProperties = binder.bind(<span class="string">"spring.datasource.master"</span>,Map<span class="class">.<span class="keyword">class</span>).<span class="title">get</span>()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>推荐使用 Binder 读取配置文件</strong></p>
<h2><span id="abstractroutingdatasource">AbstractRoutingDataSource</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractDataSource</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Object, Object&gt; targetDataSources;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Object defaultTargetDataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> lenientFallback = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> DataSourceLookup dataSourceLookup = <span class="keyword">new</span> JndiDataSourceLookup();</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Object, DataSource&gt; resolvedDataSources;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> DataSource resolvedDefaultDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractRoutingDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTargetDataSources</span><span class="params">(Map&lt;Object, Object&gt; targetDataSources)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.targetDataSources = targetDataSources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultTargetDataSource</span><span class="params">(Object defaultTargetDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultTargetDataSource = defaultTargetDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLenientFallback</span><span class="params">(<span class="keyword">boolean</span> lenientFallback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lenientFallback = lenientFallback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSourceLookup</span><span class="params">(@Nullable DataSourceLookup dataSourceLookup)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dataSourceLookup = (DataSourceLookup)(dataSourceLookup != <span class="keyword">null</span> ? dataSourceLookup : <span class="keyword">new</span> JndiDataSourceLookup());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.targetDataSources == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Property 'targetDataSources' is required"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.resolvedDataSources = <span class="keyword">new</span> HashMap(<span class="keyword">this</span>.targetDataSources.size());</span><br><span class="line">            <span class="keyword">this</span>.targetDataSources.forEach((key, value) -&gt; &#123;</span><br><span class="line">                Object lookupKey = <span class="keyword">this</span>.resolveSpecifiedLookupKey(key);</span><br><span class="line">                DataSource dataSource = <span class="keyword">this</span>.resolveSpecifiedDataSource(value);</span><br><span class="line">                <span class="keyword">this</span>.resolvedDataSources.put(lookupKey, dataSource);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.defaultTargetDataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.resolvedDefaultDataSource = <span class="keyword">this</span>.resolveSpecifiedDataSource(<span class="keyword">this</span>.defaultTargetDataSource);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">resolveSpecifiedLookupKey</span><span class="params">(Object lookupKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lookupKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DataSource <span class="title">resolveSpecifiedDataSource</span><span class="params">(Object dataSource)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> DataSource) &#123;</span><br><span class="line">            <span class="keyword">return</span> (DataSource)dataSource;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.dataSourceLookup.getDataSource((String)dataSource);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal data source value - only [javax.sql.DataSource] and String supported: "</span> + dataSource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.determineTargetDataSource().getConnection();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.determineTargetDataSource().getConnection(username, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">unwrap</span><span class="params">(Class&lt;T&gt; iface)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iface.isInstance(<span class="keyword">this</span>) ? <span class="keyword">this</span> : <span class="keyword">this</span>.determineTargetDataSource().unwrap(iface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isWrapperFor</span><span class="params">(Class&lt;?&gt; iface)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iface.isInstance(<span class="keyword">this</span>) || <span class="keyword">this</span>.determineTargetDataSource().isWrapperFor(iface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DataSource <span class="title">determineTargetDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Assert.notNull(<span class="keyword">this</span>.resolvedDataSources, <span class="string">"DataSource router not initialized"</span>);</span><br><span class="line">        Object lookupKey = <span class="keyword">this</span>.determineCurrentLookupKey();</span><br><span class="line">        DataSource dataSource = (DataSource)<span class="keyword">this</span>.resolvedDataSources.get(lookupKey);</span><br><span class="line">        <span class="keyword">if</span> (dataSource == <span class="keyword">null</span> &amp;&amp; (<span class="keyword">this</span>.lenientFallback || lookupKey == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            dataSource = <span class="keyword">this</span>.resolvedDefaultDataSource;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dataSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot determine target DataSource for lookup key ["</span> + lookupKey + <span class="string">"]"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractRoutingDataSource是spring-jdbc包提供的一个了AbstractDataSource的抽象类，它<strong>实现了DataSource接口</strong>的用于获取数据库连接的方法。</p>
<p>可以看到源码中也是通过 determineTargetDataSource() 获取到 datasource 对象，再从这个配置好的 datasource 获取到数据库连接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.determineTargetDataSource().getConnection();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.determineTargetDataSource().getConnection(username, password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点看 <strong>determineTargetDataSource()方法代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> DataSource <span class="title">determineTargetDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Assert.notNull(<span class="keyword">this</span>.resolvedDataSources, <span class="string">"DataSource router not initialized"</span>);</span><br><span class="line">    Object lookupKey = determineCurrentLookupKey();</span><br><span class="line">    DataSource dataSource = <span class="keyword">this</span>.resolvedDataSources.get(lookupKey);</span><br><span class="line">    <span class="keyword">if</span> (dataSource == <span class="keyword">null</span> &amp;&amp; (<span class="keyword">this</span>.lenientFallback || lookupKey == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        dataSource = <span class="keyword">this</span>.resolvedDefaultDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dataSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot determine target DataSource for lookup key ["</span> + lookupKey + <span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//该方法的返回值就是项目中所要用的DataSource的key值，拿到该key后就可以在resolvedDataSource中取出对应的DataSource，如果key找不到对应的DataSource就使用默认的数据源。</span></span><br></pre></td></tr></table></figure>

<p><strong>determineCurrentLookupKey 用于在获得数据库连接之前执行，以便在出现多数据源的情况下，由该方法确定调用哪个数据源key。且每切换一次数据源就会被调用一次</strong></p>
<p>总结：</p>
<p>SpringBoot 提供了 AbstractRoutingDataSource 根据用户定义的规则选择当前的数据源，这样在执行查询之前，设置使用的数据源。实现可动态路由的数据源，在每次数据库查询操作前执行。通过它的抽象方法 <strong><em>determineCurrentLookupKey()</em></strong> 获取到数据源对应的key，<strong><em>determineTargetDataSource()</em></strong> 拿到该key后就可以在resolvedDataSource中取出对应的DataSource。</p>
<h2><span id="mutablepropertyvalues">MutablePropertyValues</span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MutablePropertyValues</span> <span class="keyword">implements</span> <span class="title">PropertyValues</span>, <span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure>

<p>用过类的实现关系可知 <strong>MutablePropertyValues</strong> 实现了 <strong><em>PropertyValues接口</em></strong> </p>
<ul>
<li>PropertyValues 源码</li>
</ul>
<p><img src="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/131.png" alt="131.png"></p>
<p>由图可知，PropertyValues接口类 包含了许多对属性的基本操作：迭代，分割，获取，等</p>
<ul>
<li>MutablePropertyValues源码</li>
</ul>
<p><img src="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/132.png" alt="132.png"></p>
<p>可见 MutablePropertyValues 丰富了 PropertyValues 对属性值的操作</p>
<p><img src="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/133.png" alt="133.png"></p>
<p>且通过类的继承关系可以发现，PropertyValues 只有一个实现类：*<em>MutablePropertyValues *</em></p>
<h2><span id="threadlocal">ThreadLocal</span></h2><p><img src="https://hexo-images-mikelv.oss-cn-shenzhen.aliyuncs.com/129.png" alt="129.png"></p>
<p>Threadlocal 是一个线程内部的 <strong>存储类</strong>，可以在指定内存存储数据，数据存储以后，<strong>只有指定的线程可以得到存储数据</strong></p>
<p>ThreadLocal 提供了线程的局部变量，每个线程都可以通过 <code>set()</code> 和 <code>get()</code> 来对这个局部变量进行操作，但不会和其它线程的局部变量进行冲突，<strong>实现了线程的数据隔离</strong></p>
<h3><span id="threadlocalmap">ThreadLocalMap</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//源码</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalMap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The entries in this hash map extend WeakReference, using</span></span><br><span class="line"><span class="comment">         * its main ref field as the key (which is always a</span></span><br><span class="line"><span class="comment">         * ThreadLocal object).  Note that null keys (i.e. entry.get()</span></span><br><span class="line"><span class="comment">         * == null) mean that the key is no longer referenced, so the</span></span><br><span class="line"><span class="comment">         * entry can be expunged from table.  Such entries are referred to</span></span><br><span class="line"><span class="comment">         * as "stale entries" in the code that follows.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">        Object value;</span><br><span class="line"></span><br><span class="line">        Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">            <span class="keyword">super</span>(k);</span><br><span class="line">            value = v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....很长</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看源码可知，ThreadLocalMap 是 ThreadLocal 的一个内部类。用 Entry 类来进行存储。</p>
<p>先来看 set()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到当前线程对象</span></span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里获取ThreadLocalMap</span></span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果map存在，则将当前线程对象t作为key，要存储的对象作为value存到map里面去</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        map.set(<span class="keyword">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的<strong>值都是存储到这个 Map 上的，key 是当前 ThreadLocal 对象</strong></p>
<p><strong>Thread为每个线程维护了ThreadLocalMap这么一个Map，而ThreadLocalMap的key是LocalThread对象本身，value则是要存储的对象</strong></p>
<p>有了上面的基础，我们看get()方法就一点都不难理解了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<h3><span id="总结">总结</span></h3></blockquote>
<ol>
<li>每个Thread维护着一个ThreadLocalMap的引用</li>
<li>ThreadLocalMap是ThreadLocal的内部类，用<strong>Entry</strong>来进行存储</li>
<li>调用ThreadLocal的set()方法时，实际上就是往ThreadLocalMap设置值，key是ThreadLocal对象，值是传递进来的对象</li>
<li>调用ThreadLocal的get()方法时，实际上就是往ThreadLocalMap获取值，key是ThreadLocal对象</li>
<li><strong>ThreadLocal本身并不存储值</strong>，它只是<strong>作为一个key来让线程从ThreadLocalMap获取value</strong>。</li>
</ol>
<blockquote>
<h3><span id="避免内存泄漏">避免内存泄漏</span></h3></blockquote>
<p>我们来看一下ThreadLocal的对象关系引用图：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC80LzMvMTYyODk2YWIxYTFkMWUyZQ?x-oss-process=image/format,png" alt="img"></p>
<p>ThreadLocal内存泄漏的根源是：<strong>由于ThreadLocalMap的生命周期跟Thread一样长，如果没有手动删除对应key就会导致内存泄漏，而不是因为弱引用</strong>。</p>
<p>想要避免内存泄露就要<strong>手动remove()掉</strong>！</p>
<h2><span id="aop">AOP</span></h2><p>要在 Spring 中声明 AspectJ 切面, 只需要在 IOC 容器中将切面声明为 Bean 实例. 当在 Spring IOC 容器中初始化 AspectJ 切面之后, Spring IOC 容器就会为那些与 AspectJ 切面<strong>相匹配的 Bean 创建代理</strong>。</p>
<p>在切面类中需要定义切面方法用于响应响应的目标方法，切面方法即为通知方法，通知方法需要用注解标识，AspectJ 支持 5 种类型的通知注解:</p>
<ul>
<li><strong>@Before</strong>: 前置通知, 在方法执行之前执行</li>
<li><strong>@After</strong>: 后置通知, 在方法执行之后执行 。</li>
<li><strong>@AfterRunning</strong>: 返回通知, 在方法返回结果之后执行</li>
<li><strong>@AfterThrowing</strong>: 异常通知, 在方法抛出异常之后</li>
<li><strong>@Around</strong>: 环绕通知, 围绕着方法执行</li>
</ul>
<p>以上5种类型的通知注解的值可以为 <strong><em>@annotation</em></strong>表示标注了某个注解的所有方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"@annotation(ds)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeDataSource</span><span class="params">(JoinPoint point, DataSourceKey ds)</span></span></span><br></pre></td></tr></table></figure>

<p>执行的顺序如下：</p>
<p><strong>正常情况：</strong><br><img src="https://img-blog.csdn.net/20160811192425854" alt="one-ok"></p>
<hr>
<p><strong>异常情况：</strong><br><img src="https://img-blog.csdn.net/20160811192446479" alt="one-exception"></p>
<h3><span id="joinpoint">JoinPoint</span></h3><p>JoinPoint 对象封装了 SpringAop 中<strong>切面方法的信息</strong>，在切面方法中添加JoinPoint参数,就可以获取到封装了该方法信息的JoinPoint对象.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"@annotation(ds)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeDataSource</span><span class="params">(JoinPoint point, DataSourceKey ds)</span></span>&#123;</span><br><span class="line">    String dsId = ds.value();</span><br><span class="line">    <span class="keyword">if</span>(DynamicDataSourceContextHolder.dataSourceIds.contains(dsId))&#123;</span><br><span class="line">        <span class="comment">//当日志级别为 debug 时输出</span></span><br><span class="line">        <span class="comment">//point.getSignature() 获取切入点的方法名</span></span><br><span class="line">        logger.debug(<span class="string">"Use DataSourceKey :&#123;&#125; &gt;"</span>, dsId, point.getSignature());</span><br><span class="line">        <span class="comment">//设置数据源的 key</span></span><br><span class="line">        DynamicDataSourceContextHolder.setDataSourceRouterKey(dsId);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//point.getSignature() 获取切入点的方法名</span></span><br><span class="line">        logger.info(<span class="string">"数据源[&#123;&#125;]不存在，使用默认数据源 &gt;&#123;&#125;"</span>, dsId, point.getSignature());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="logger">Logger</span></h2><p>在编程中尽量用 Logger(org.slf4j.Logger) 来输出信息，避免使用 sout</p>
<p>因为 Logger 提供了 5 种日志级别的输出：</p>
<ol>
<li><strong>error</strong></li>
<li><strong>warn</strong></li>
<li><strong>info</strong></li>
<li><strong>debug</strong></li>
<li><strong>trace</strong></li>
</ol>
<p>可在 application.yml 等配置日志输出级别，实现输出不同级别的日志信息按照需求输出，不像 sout 无法控制</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"@annotation(ds)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeDataSource</span><span class="params">(JoinPoint point, DataSourceKey ds)</span></span>&#123;</span><br><span class="line">    String dsId = ds.value();</span><br><span class="line">    <span class="keyword">if</span>(DynamicDataSourceContextHolder.dataSourceIds.contains(dsId))&#123;</span><br><span class="line">        logger.debug(<span class="string">"Use DataSourceKey :&#123;&#125; &gt;"</span>, dsId, point.getSignature());</span><br><span class="line">        DynamicDataSourceContextHolder.setDataSourceRouterKey(dsId);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        logger.info(<span class="string">"数据源[&#123;&#125;]不存在，使用默认数据源 &gt;&#123;&#125;"</span>, dsId, point.getSignature());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@After</span>(<span class="string">"@annotation(ds)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreDataSource</span><span class="params">(JoinPoint point, DataSourceKey ds)</span></span>&#123;</span><br><span class="line">    logger.debug(<span class="string">"Revert DataSourceKey : "</span> + ds.value() + <span class="string">" &gt; "</span> + point.getSignature());</span><br><span class="line">    <span class="comment">//移除 ThreadLocalMap 中存储的 ThreadLocal对象和值，避免内存溢出</span></span><br><span class="line">    DynamicDataSourceContextHolder.removeDataSourceRouterKey();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码有两个输出级别：debug 和 info</p>
<p>当在 application.yml 中配置 logging.level.root=info 时，info级别的日志得到输出，debug同理</p>
<p><img src="https://img-blog.csdnimg.cn/20200306232559114.png" alt="image-20200306154105726"></p>
<h2><span id="datasourcebuilder">DataSourceBuilder</span></h2><p>示例：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">customize.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/blue?serverTimezone=UTC</span></span><br><span class="line"><span class="meta">customize.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">customize.datasource.password</span>=<span class="string">wan4380797</span></span><br><span class="line"><span class="meta">customize.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSource;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dbcp2DataSource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"myDbcp2DataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"customize.datasource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().type(BasicDataSource<span class="class">.<span class="keyword">class</span>).<span class="title">build</span>()</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2><span id="binder">Binder</span></h2><p>对于 Binder，只要会用就差不多了，等功力达到以后再深入源码</p>
<blockquote>
<h3><span id="示例1-简单类型">示例1 简单类型</span></h3></blockquote>
<p>假设在propertes配置中有这样一个配置：<code>com.didispace.foo=bar</code></p>
<p>我们为它创建对应的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"com.didispace"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String foo;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，通过最新的<code>Binder</code>就可以这样来拿配置信息了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext context = SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">        Binder binder = Binder.get(context.getEnvironment());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定简单配置</span></span><br><span class="line">        FooProperties foo = binder.bind(<span class="string">"com.didispace"</span>, Bindable.of(FooProperties<span class="class">.<span class="keyword">class</span>)).<span class="title">get</span>()</span>;</span><br><span class="line">        System.out.println(foo.getFoo());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<h3><span id="示例2-list类型">示例2 List类型</span></h3></blockquote>
<p>如果配置内容是List类型呢？比如：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">com.didispace.post[0]</span>=<span class="string">Why Spring Boot</span></span><br><span class="line"><span class="meta">com.didispace.post[1]</span>=<span class="string">Why Spring Cloud</span></span><br><span class="line"></span><br><span class="line"><span class="meta">com.didispace.posts[0].title</span>=<span class="string">Why Spring Boot</span></span><br><span class="line"><span class="meta">com.didispace.posts[0].content</span>=<span class="string">It is perfect!</span></span><br><span class="line"><span class="meta">com.didispace.posts[1].title</span>=<span class="string">Why Spring Cloud</span></span><br><span class="line"><span class="meta">com.didispace.posts[1].content</span>=<span class="string">It is perfect too!</span></span><br></pre></td></tr></table></figure>

<p>要获取这些配置依然很简单，可以这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">Binder binder = Binder.get(context.getEnvironment());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定List配置</span></span><br><span class="line">List&lt;String&gt; post = binder.bind(<span class="string">"com.didispace.post"</span>, Bindable.listOf(String<span class="class">.<span class="keyword">class</span>)).<span class="title">get</span>()</span>;</span><br><span class="line">System.out.println(post);</span><br><span class="line"></span><br><span class="line">List&lt;PostInfo&gt; posts = binder.bind(<span class="string">"com.didispace.posts"</span>, Bindable.listOf(PostInfo<span class="class">.<span class="keyword">class</span>)).<span class="title">get</span>()</span>;</span><br><span class="line">System.out.println(posts)</span><br></pre></td></tr></table></figure>

<h3><span id="源码">源码</span></h3><p>里面 bind() 方法有许多重载，重点关注这个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">bind</span><span class="params">(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler, <span class="keyword">boolean</span> create)</span> </span>&#123;</span><br><span class="line">    Assert.notNull(name, <span class="string">"Name must not be null"</span>);</span><br><span class="line">    Assert.notNull(target, <span class="string">"Target must not be null"</span>);</span><br><span class="line">    handler = handler != <span class="keyword">null</span> ? handler : <span class="keyword">this</span>.defaultBindHandler;</span><br><span class="line">    Binder.Context context = <span class="keyword">new</span> Binder.Context();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.bind(name, target, handler, context, <span class="keyword">false</span>, create);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里还不是真正的绑定阶段，但有两个点需要说明：</p>
<ul>
<li>参数<strong>ConfigurationPropertyName</strong>：是对前面传入的配置前缀 prefix 进行一些基本校验和处理</li>
<li>返回值<strong>BindResult</strong>：里面有<code>of()</code>, <code>get()</code>, <code>isBound()</code>, <code>orElse()</code>等</li>
<li><strong>Context</strong>：在这里是绑定上下文, 由前面说过的<code>BindHandler</code>使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BindContext</span> </span>&#123;</span><br><span class="line">    <span class="function">Binder <span class="title">getBinder</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getDepth</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Iterable&lt;ConfigurationPropertySource&gt; <span class="title">getSources</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ConfigurationProperty <span class="title">getConfigurationProperty</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟着代码往下，看 Binder 中的下一个bind() 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">bind</span><span class="params">(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler, Binder.Context context, <span class="keyword">boolean</span> allowRecursiveBinding, <span class="keyword">boolean</span> create)</span> </span>&#123;</span><br><span class="line">    context.clearConfigurationProperty();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Bindable&lt;T&gt; replacementTarget = handler.onStart(name, target, context);</span><br><span class="line">        <span class="keyword">if</span> (replacementTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.handleBindResult(name, target, handler, context, (Object)<span class="keyword">null</span>, create);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object bound = <span class="keyword">this</span>.bindObject(name, replacementTarget, handler, context, allowRecursiveBinding);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.handleBindResult(name, replacementTarget, handler, context, bound, create);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var9) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.handleBindError(name, target, handler, context, var9);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>留意 onStart ，这里就有一个 BindHandler 回调接口中的一个方法，也就是绑定的开始但还未完成阶段</p>
<p>接下来在<code>Binder</code>中, 会陆续看到其它几个阶段的方法</p>
<p>再来看返回, 是通过<code>handleBindResult()</code>和<code>handleBindError()</code>来处理的.</p>
<p>点开这两个handleBindXXX()能看到在里面进行了onSuccess, onFinish, onFailure的调用</p>
<ul>
<li>handleBindResult() 源码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">handleBindResult</span><span class="params">(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler, Binder.Context context, Object result, <span class="keyword">boolean</span> create)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = handler.onSuccess(name, target, context, result);</span><br><span class="line">        result = context.getConverter().convert(result, target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; create) &#123;</span><br><span class="line">        result = <span class="keyword">this</span>.create(target, context);</span><br><span class="line">        result = handler.onCreate(name, target, context, result);</span><br><span class="line">        result = context.getConverter().convert(result, target);</span><br><span class="line">        Assert.state(result != <span class="keyword">null</span>, () -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Unable to create instance for "</span> + target.getType();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handler.onFinish(name, target, context, result);</span><br><span class="line">    <span class="keyword">return</span> context.getConverter().convert(result, target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>handleBindError() 源码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">handleBindError</span><span class="params">(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler, Binder.Context context, Exception error)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object result = handler.onFailure(name, target, context, error);</span><br><span class="line">        <span class="keyword">return</span> context.getConverter().convert(result, target);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">        <span class="keyword">if</span> (var7 <span class="keyword">instanceof</span> BindException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (BindException)var7;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindException(name, target, context.getConfigurationProperty(), var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点来看 <strong><em>bindObject()</em></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Object <span class="title">bindObject</span><span class="params">(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler, Binder.Context context, <span class="keyword">boolean</span> allowRecursiveBinding)</span> </span>&#123;</span><br><span class="line">    ConfigurationProperty property = <span class="keyword">this</span>.findProperty(name, context);</span><br><span class="line">    <span class="keyword">if</span> (property == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.containsNoDescendantOf(context.getSources(), name) &amp;&amp; context.depth != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        AggregateBinder&lt;?&gt; aggregateBinder = <span class="keyword">this</span>.getAggregateBinder(target, context);</span><br><span class="line">        <span class="keyword">if</span> (aggregateBinder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.bindAggregate(name, target, handler, context, aggregateBinder);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (property != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.bindProperty(target, context, property);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ConverterNotFoundException var10) &#123;</span><br><span class="line">                Object instance = <span class="keyword">this</span>.bindDataObject(name, target, handler, context, allowRecursiveBinding);</span><br><span class="line">                <span class="keyword">if</span> (instance != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> instance;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> var10;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.bindDataObject(name, target, handler, context, allowRecursiveBinding);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里过程比较多，可以分为 2 个部分</p>
<p><strong>Part1</strong>：寻找属性和匹配的过程</p>
<p>开头的<code>findProperty()</code>和一个匹配方法:<code>containsNoDescendantOf()</code>, 它们的参数都有<code>context</code></p>
<p>上面说过了–&gt;提供绑定的上下文信息</p>
<p><strong>Part2</strong>：绑定过程</p>
<p>接下来是 bindXXX 这三个私有方法：</p>
<ul>
<li><p><code>bindAggregate()</code>: 从注释上看出, 主要是负责处理Map, Collections, Array的绑定策略, 及完成多层属性的递归</p>
</li>
<li><p><code>bindProperty()</code>: 是返回属性值的过程(其中包含类型转换)</p>
<p>例如属性资源文件中配置的<code>name=thank</code> -&gt; <code>java.lang.String thank</code></p>
</li>
<li><p><code>bindBean()</code>: 会继续调用另外一个私有的重载函数<code>bindBean()</code></p>
</li>
</ul>
<p>重点看看这个方法 — bindDataObject()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">bindDataObject</span><span class="params">(ConfigurationPropertyName name, Bindable&lt;?&gt; target, BindHandler handler, Binder.Context context, <span class="keyword">boolean</span> allowRecursiveBinding)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isUnbindableBean(name, target, context)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Class&lt;?&gt; type = target.getType().resolve(Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!allowRecursiveBinding &amp;&amp; context.isBindingDataObject(type)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            DataObjectPropertyBinder propertyBinder = (propertyName, propertyTarget) -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.bind(name.append(propertyName), propertyTarget, handler, context, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> context.withDataObject(type, () -&gt; &#123;</span><br><span class="line">                Iterator var5 = <span class="keyword">this</span>.dataObjectBinders.iterator();</span><br><span class="line"></span><br><span class="line">                Object instance;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!var5.hasNext()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    DataObjectBinder dataObjectBinder = (DataObjectBinder)var5.next();</span><br><span class="line">                    instance = dataObjectBinder.bind(name, target, context, propertyBinder);</span><br><span class="line">                &#125; <span class="keyword">while</span>(instance == <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> instance;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>里面又调用了上层的<code>Binder.bind()</code>, 递归完成绑定</p>
<p>终止条件是上面提到过的<code>containsNoDescendantOf()</code>和另外一个判断<code>isUnbindableBean()</code></p>
<p>关注一下最终的返回结果, 是调用了另外一个类: <code>JavaBeanBinder</code>的<code>bind</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;BeanBinder&gt; BEAN_BINDERS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        List&lt;BeanBinder&gt; binders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        binders.add(<span class="keyword">new</span> JavaBeanBinder());</span><br><span class="line">        BEAN_BINDERS = Collections.unmodifiableList(binders);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5><span id="bind">bind()</span></h5><p>进入<code>JavaBeanBinder#bind()</code>之后看到继续调用了另一个私有的重载方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">bind</span><span class="params">(BeanPropertyBinder propertyBinder, Bean&lt;T&gt; bean, BeanSupplier&lt;T&gt; beanSupplier)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> bound = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, BeanProperty&gt; entry : bean.getProperties().entrySet()) &#123;</span><br><span class="line">        bound |= bind(beanSupplier, propertyBinder, entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bound;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>里面会迭代该配置bean中的所有属性, 调试模式下随便取一个来看看:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0 = &#123;LinkedHashMap<span class="variable">$Entry</span><span class="variable">@7470</span>&#125; <span class="string">"name"</span> -&gt; </span><br><span class="line">  key = <span class="string">"name"</span></span><br><span class="line">  value = &#123;JavaBeanBinder<span class="variable">$BeanProperty</span><span class="variable">@7475</span>&#125; </span><br><span class="line">    name = <span class="string">"name"</span></span><br><span class="line">    declaringClassType = &#123;ResolvableType<span class="variable">@7481</span>&#125; <span class="string">"com.example.cache.config.CustomProperties"</span></span><br><span class="line">    getter = &#123;Method<span class="variable">@7482</span>&#125; <span class="string">"public java.lang.String com.example.cache.config.CustomProperties.getName()"</span></span><br><span class="line">    setter = &#123;Method<span class="variable">@7483</span>&#125; <span class="string">"public void com.example.cache.config.CustomProperties.setName(java.lang.String)"</span></span><br><span class="line">    field = &#123;Field<span class="variable">@7484</span>&#125; <span class="string">"private java.lang.String com.example.cache.config.CustomProperties.name"</span></span><br><span class="line"><span class="number">1</span> = &#123;LinkedHashMap<span class="variable">$Entry</span><span class="variable">@7471</span>&#125; <span class="string">"age"</span> -&gt; </span><br><span class="line"><span class="number">2</span> = &#123;LinkedHashMap<span class="variable">$Entry</span><span class="variable">@7472</span>&#125; <span class="string">"email"</span> -&gt;</span><br></pre></td></tr></table></figure>

<p>没错, 配置bean中: 的属性名, Setter和Getter 该有的都有了</p>
<p>下面来到<code>JavaBeanBinder</code>的最后一个重载方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">bind</span><span class="params">(BeanSupplier&lt;T&gt; beanSupplier, </span></span></span><br><span class="line"><span class="function"><span class="params">                         BeanPropertyBinder propertyBinder, BeanProperty property)</span> </span>&#123;</span><br><span class="line">    String propertyName = property.getName();</span><br><span class="line">    ResolvableType type = property.getType();</span><br><span class="line">    Supplier&lt;Object&gt; value = property.getValue(beanSupplier);</span><br><span class="line">    Annotation[] annotations = property.getAnnotations();</span><br><span class="line">    Object bound = propertyBinder.bindProperty(</span><br><span class="line">        propertyName, Bindable.of(type).withSuppliedValue(value).withAnnotations(annotations)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (bound == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (property.isSettable()) &#123;</span><br><span class="line">        property.setValue(beanSupplier, bound);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (value == <span class="keyword">null</span> || !bound.equals(value.get())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No setter found for property: "</span> + property.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就比较简单了, 分步拿到了配置Bean属性的定义和值:</p>
<ul>
<li><p>field: 即propertyName, e.g. <code>name</code></p>
</li>
<li><p>属性类型: type, e.g. <code>java.lang.String</code></p>
</li>
<li><p>getter and setter</p>
<p>e.g.<code>public void com.example.cache.config.CustomProperties.setName(java.lang.String)</code></p>
</li>
<li><p>以及调用<code>propertyBinder.bindProperty()</code>拿到了资源属性文件中的属性值<code>bound</code></p>
<p>该方法的作用前面也提到过(e.g. <code>thank</code> )</p>
</li>
</ul>
<p>然后调用了属性的<code>setValue()</code>方法: 执行<code>property.setValue(beanSupplier, bound);</code></p>
<p>至此, 看到了调用属性的set方法, 终于可以放心了!</p>
<p>从<code>ConfigurationPropertiesBindingPostProcessor</code>开始到调用setter结束, 完整的调用栈如下:</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">bind:85, JavaBeanBinder &#123;<span class="attribute">org.springframework.boot.context.properties.bind&#125;</span></span><br><span class="line"><span class="attribute">bind</span>:62, JavaBeanBinder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">bind:54, JavaBeanBinder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">lambda$null$5:341, Binder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">apply:-1, 1445225850 &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span><span class="variable">.Binder</span>$$Lambda$267&#125;</span><br><span class="line">accept:193, ReferencePipeline$3$1 &#123;java<span class="variable">.util</span><span class="variable">.stream</span>&#125;</span><br><span class="line">tryAdvance:1351, ArrayList$ArrayListSpliterator &#123;java<span class="variable">.util</span>&#125;</span><br><span class="line">forEachWithCancel:126, ReferencePipeline &#123;java<span class="variable">.util</span><span class="variable">.stream</span>&#125;</span><br><span class="line">copyIntoWithCancel:498, AbstractPipeline &#123;java<span class="variable">.util</span><span class="variable">.stream</span>&#125;</span><br><span class="line">copyInto:485, AbstractPipeline &#123;java<span class="variable">.util</span><span class="variable">.stream</span>&#125;</span><br><span class="line">wrapAndCopyInto:471, AbstractPipeline &#123;java<span class="variable">.util</span><span class="variable">.stream</span>&#125;</span><br><span class="line">evaluateSequential:152, FindOps$FindOp &#123;java<span class="variable">.util</span><span class="variable">.stream</span>&#125;</span><br><span class="line">evaluate:234, AbstractPipeline &#123;java<span class="variable">.util</span><span class="variable">.stream</span>&#125;</span><br><span class="line">findFirst:464, ReferencePipeline &#123;java<span class="variable">.util</span><span class="variable">.stream</span>&#125;</span><br><span class="line">lambda$bindBean$6:342, Binder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">get:-1, 2008619427 &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span><span class="variable">.Binder</span>$$Lambda$266&#125;</span><br><span class="line">withIncreasedDepth:441, Binder$Context &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">withBean:427, Binder$Context &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">access$400:381, Binder$Context &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">bindBean:339, Binder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">bindObject:278, Binder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">bind:221, Binder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">bind:210, Binder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">bind:192, Binder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span><span class="variable">.bind</span>&#125;</span><br><span class="line">bind:82, ConfigurationPropertiesBinder &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span>&#125;</span><br><span class="line">bind:107, ConfigurationPropertiesBindingPostProcessor &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span>&#125;</span><br><span class="line">postProcessBeforeInitialization:93, ConfigurationPropertiesBindingPostProcessor &#123;org<span class="variable">.springframework</span><span class="variable">.boot</span><span class="variable">.context</span><span class="variable">.properties</span>&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="import">@Import</span></h2><p>参考：</p>
<p><a href="https://blog.csdn.net/pange1991/article/details/81356594" target="_blank" rel="noopener">Spring @Import注解 —— 导入资源</a></p>
<p><a href="https://blog.csdn.net/tuoni123/article/details/80213050" target="_blank" rel="noopener">SpringBoot @Import 详解</a></p>
<p><a href="https://juejin.im/post/5c761c096fb9a049b41d2299" target="_blank" rel="noopener">Spring Boot 自动配置之@Enable* 与@Import注解</a></p>
<p>SpringBoot 的 @Import 用于将指定的类示例注入到 Spring IOC Container 中。</p>
<p>提供了三种方法：</p>
<ul>
<li>直接注入(@Import)</li>
<li>实现 ImportBeanDefinitionRegistrar 接口 注入</li>
<li>实现 ImportSelector 注入</li>
</ul>
<h2><span id="流程图">流程图</span></h2><p><img src="https://img-blog.csdnimg.cn/20200307165337725.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pa2VsdjAx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>mikelv
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://01lv.github.io/2020/03/05/SpringBoot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%88%87%E6%8D%A2%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" title="SpringBoot多数据源切换学习总结">https://01lv.github.io/2020/03/05/SpringBoot多数据源切换学习总结/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SpringBoot/" rel="tag"># SpringBoot</a>
              <a href="/tags/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/" rel="tag"># 多数据源</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/04/Spring%E4%B9%8BBeanDefinitionRegistry/" rel="prev" title="Spring之BeanDefinitionRegistry">
      <i class="fa fa-chevron-left"></i> Spring之BeanDefinitionRegistry
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/07/SpringBoot%E6%95%B4%E5%90%88Swagger/" rel="next" title="SpringBoot整合Swagger">
      SpringBoot整合Swagger <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">数据源定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">SpringBoot 读取配置文件方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">AbstractRoutingDataSource</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">MutablePropertyValues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">ThreadLocal</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">ThreadLocalMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">避免内存泄漏</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">JoinPoint</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">Logger</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">DataSourceBuilder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">Binder</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">示例1 简单类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">示例2 List类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#null"><span class="nav-text">源码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#null"><span class="nav-text">bind()</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">@Import</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#null"><span class="nav-text">流程图</span></a></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="mikelv"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">mikelv</p>
  <div class="site-description" itemprop="description">放弃不难，但坚持一定很酷</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">113</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">132</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/01Lv" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;01Lv" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yisheng.mikelv@foxmail.com" title="E-Mail → mailto:yisheng.mikelv@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">mikelv</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">439k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:39</span>

  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_pv">
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    访问量：<span id="busuanzi_value_site_pv"></span> 次数
  </span>

  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_uv">
    访客数：<span id="busuanzi_value_site_uv"></span> 人次
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'vUOBlgy4bWczaSuWqPWA4Orb-gzGzoHsz',
      appKey     : 'c6DxvrOXBybBJ2w0DCsMGKeM',
      placeholder: "皮一下也很开心哦!",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
